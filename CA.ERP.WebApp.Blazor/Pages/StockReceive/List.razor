@page "/stock-receive/"

@using CA.ERP.Shared.Dto.StockReceive;
@using CA.ERP.Shared.Dto.Supplier;
@using CA.ERP.Shared.Dto.Branch;
@using CA.ERP.WebApp.Blazor.ViewModels.StockReceive;

@inherits ViewBase<StockReceiveListViewModel>

@inject IDialogService DialogService;


@attribute [Authorize]

<MudContainer>
    <MudPaper Class="d-flex justify-space-between mt-4 pa-4">
        <MudText Typo="Typo.h6">Stock Receive List</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@ShowGenerateFromPurchaseOrder" DisableElevation="true">Generate</MudButton>
    </MudPaper>
    <MudTable Class="mt-8" ServerData="ServerReload" Hover="true" Striped="true" @ref="table">
        <ToolBarContent>
            <MudAutocomplete Class="mx-4" T="BranchView" Label="Branch" @bind-Value="ViewModel.SelectedBranch" SearchFunc="@ViewModel.SearchBranches" ToStringFunc="@(s => s.Name)" ResetValueOnEmptyText="true" CoerceText="true" MaxItems="null" />
            <MudAutocomplete Class="mx-4" T="SupplierView" Label="Supplier" @bind-Value="ViewModel.SelectedSupplier" SearchFunc="@ViewModel.SearchSuppliers" ToStringFunc="@(s => s.Name)" ResetValueOnEmptyText="true" CoerceText="true" MaxItems="null" />
            <MudDatePicker Class="mx-4" Label="Date Created" @bind-Date="ViewModel.DateCreated" />
            <MudDatePicker Class="mx-4" Label="Date Received" @bind-Date="ViewModel.DateReceive" />
            <MudButton Class="mt-4" Variant="Variant.Filled" Color="Color.Primary"  StartIcon="@Icons.Filled.Search" OnClick="Search" DisableElevation="true">
                Search
            </MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Branch</MudTh>
            <MudTh>Supplier</MudTh>
            <MudTh>Source</MudTh>
            <MudTh>Created At</MudTh>
            <MudTh>Received At</MudTh>
            <MudTh>Delivery Reference</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Branch">@context.BranchName</MudTd>
            <MudTd DataLabel="Supplier">@context.SupplierName</MudTd>
            <MudTd DataLabel="Source">@context.StockSource</MudTd>
            <MudTd DataLabel="Created At">@(context.DateCreated.ToString("MMM dd, yyyy")) </MudTd>
            <MudTd DataLabel="Received At">@(context.DateReceived?.ToString("MMM dd, yyyy") ?? "N/A") </MudTd>
            <MudTd DataLabel="Delivery Reference">@(context.DeliveryReference ?? "n/a") </MudTd>
            <MudTd DataLabel="Delivery Reference">@context.Stage </MudTd>
            <MudTd DataLabel="Action">
                <MudIconButton Icon="@Icons.Outlined.Edit" Link="@("/stock-receive/edit/" + context.Id)" />
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />

        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    MudTable<StockReceiveView> table;

    public void ShowGenerateFromPurchaseOrder()
    {
        DialogService.Show<CA.ERP.WebApp.Blazor.Pages.StockReceive.GenerateFromPurchaseOrderDialog>();
    }

    public async Task Search()
    {
        table.CurrentPage = 0;
        await table.ReloadServerData();
    }

    private async Task<TableData<StockReceiveView>> ServerReload(TableState state)
    {
        var paginatedStockRecieves = await ViewModel.SearchStockReceivesAsync(state.Page, state.PageSize);
        return new TableData<StockReceiveView>() { TotalItems = paginatedStockRecieves.TotalCount, Items = paginatedStockRecieves.Data };
    }


}
